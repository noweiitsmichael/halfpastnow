<%# TODO: put this stuff in the controller eventually %>

<% content_for :code do %>
	<% 	@now = DateTime.now.change(:hour => 0)
		@channels = current_user ? current_user.channels.sort_by { |channel| channel.created_at } : Channel.default_channels %>

	<script type="text/javascript">
		var geocoder;
		var map;
		var markers = [];
		var tags = {};
		var channelFilters = {};

		var filter = {
		  option_day: <%= params[:option_day].coalesce_to 1 %>,
		  start_days: <%= params[:start_days].coalesce_to 0 %>,
		  end_days: isNaN(parseInt("<%= params[:end_days] || 0 %>")) ? "<%= params[:end_days] %>" : <%= params[:end_days].coalesce_to 0 %>,
		  start_seconds: <%= params[:start_seconds].coalesce_to "''" %>,
		  end_seconds: <%= params[:end_seconds].coalesce_to "''" %>,
		  day: [0,1,2,3,4,5,6],
		  low_price: <%= params[:low_price].coalesce_to "''" %>,
		  high_price: <%= params[:high_price].coalesce_to "''" %>,
		  included_tags: <%= params[:included_tags] ? "[" + (params[:included_tags] * ",") + "]" : "[]" %>,
		  excluded_tags: <%= params[:excluded_tags] ? "[" + (params[:included_tags] * ",") + "]" : "[]" %>,
		  lat_min: "",
		  lat_max: "",
		  long_min: "",
		  long_max: "",
		  offset: 0,
		  search: "",
		  sort: <%= params[:sort].coalesce_to 0 %>,
		  name: "<%= params[:name].coalesce_to "" %>"
		};

		function initialize() {
			console.log("initialize");
			//$("#map").height($(window).height() - $("#map").offset().top - 2 * parseInt($("#map").css("border-top-width")));
			geocoder = new google.maps.Geocoder();

			var styles = [
			    {
			      stylers: [
			        { saturation: 0 },
			        { invert_lightness: false },
			        { gamma: 1 },
			        { lightness: 0 }
			      ]
			    }];

			var latlng = new google.maps.LatLng(<%= @lat %>, <%= @long %>);
			var myOptions = {
				zoom: <%= @zoom %>,
				center: latlng,
				mapTypeId: 'map_style',
				disableDefaultUI: true,
				zoomControl: true,
				scrollwheel: false,
				zoomControlOptions: { position: google.maps.ControlPosition.TOP_LEFT, style: google.maps.ZoomControlStyle.LARGE }
			};

			var styledMap = new google.maps.StyledMapType(styles,
    			{name: "Styled Map"});

			map = new google.maps.Map($("#map")[0], myOptions);

			map.mapTypes.set('map_style', styledMap);
  			map.setMapTypeId('map_style');

			var locations = [];
			
			$("#content .main .inner .events li").each(function(index) {
				var latitude = parseFloat($(this).find(".latitude").html());
				var longitude = parseFloat($(this).find(".longitude").html());
				locations.push({lat: latitude, long: longitude});
			});
			
			placeMarkers({points: locations});

			google.maps.event.addListener(map, 'idle', boundsChanged);
		}



		$(function() {
			<% @channels.each do |channel| %>
				channelFilters[<%= channel.id %>] = {
				  stream_id: <%= channel.id %>,
				  option_day: <%= channel.option_day || 1 %>,
				  start_days: <%= channel.start_days || 0 %>,
				  end_days: <%= channel.end_days || 0 %>,
				  start_seconds: <%= channel.start_seconds || "''" %>,
				  end_seconds: <%= channel.end_seconds || "''" %>,
				  day: [0,1,2,3,4,5,6],
				  low_price: <%= channel.low_price || "''" %>,
				  high_price: <%= channel.high_price || "''" %>,
				  included_tags: <%= channel.included_tags ? "'" + channel.included_tags + "'.split(',')" : "[]" %>,
				  excluded_tags: <%= channel.excluded_tags ? "'" + channel.excluded_tags + "'.split(',')" : "[]" %>,
				  lat_min: "",
				  lat_max: "",
				  long_min: "",
				  long_max: "",
				  offset: 0,
				  search: "",
				  sort: <%= channel.sort || 0 %>,
				  name: "<%= channel.name || "" %>"
				};
			<% end %>

    		channelFilters[0] = { 
    			  stream_id: "",
    			  option_day: 0,
				  start_days: 0,
				  end_days: 'INFINITY',
				  start_seconds: '',
				  end_seconds: '',
				  day: [0,1,2,3,4,5,6],
				  low_price: '',
				  high_price: '',
				  included_tags: [],
				  excluded_tags: [],
				  lat_min: "",
				  lat_max: "",
				  long_min: "",
				  long_max: "",
				  offset: 0,
				  search: "",
				  name: "",
				  start_date: "",
				  end_date: "" };

			// filter.search = "<%= params[:search] %>";
			<% if false %>
				// <% @tags.each do |tag| %>
				// tags[<%= tag.id %>] = "<%= tag.name %>";
				// <% end %>
			<% end %>

			<% @tagCounts.each do |tagCount| %>
			tags['<%= tagCount[:id] %>'] = 
				{ name: "<%= tagCount[:name] %>",
				  parent_id: <%= tagCount[:parent] ? "'#{tagCount[:parent][:id]}'" : 'null' %>,
				  <% children = tagCount[:children].collect { |child| "'#{child[:id]}'" } * ',' %>
				  child_ids: [<%= children %>]
				}
			<% end %>

			console.log(tags);
		});
	</script>
<% end %>

<% content_for :header do %>
	<%#= render :partial => "layouts/font_select" %>

	<div class="bar-wrapper">
		<div class="streambar">
			<div class="stay-on-target">
				<div class="header">
					<% @selectedChannel = params[:channel_id].coalesce_to 0 %>
					<!-- <span class="stream <%= @selectedChannel == 0 ? "selected" : ""%>" channel-id="0">All Events</span> -->
					<span class="stream new" <%= current_user ? "linkto='new-channel-2'" : "linkto='shunt'" %>>+ New Stream</span>
					<% @channels.each do |channel| %>
						<span class="stream <%= (@selectedChannel.to_i == channel.id) ? "selected" : ""%>" channel-id="<%= channel.id %>"><%= channel.name %></span>
					<% end %>
				</div>
			</div>
		</div>
		<div class="filterbar">
			<div class="stay-on-target">
				<div class="header">
					<div class="toggle-wrapper">
						
						<span class="filter-toggle search">
							<span class="filter-text">
								<span class="pre-text"><span class="icon icon-search"></span></span>
								<span class="text">
									<span class="text-inner"><input type="text" class="search-input" /></span>
								</span>
							</span>
						</span>
						<span class="filter-toggle tags">
							<span class="filter-text">
								<span class="pre-text"><span class="icon icon-tags"></span>Tags</span>
								<span class="text">
									<span class="text-inner">Any Tag</span>
									<span class="icon icon-caret-down"></span>
								</span>
							</span>
							<div class="filter-dropdown">
								<div class="filter-inner">
									<%= render :partial => "tag_list", :locals => { :tagCounts => @tagCounts, :parentTags => @parentTags } %>
								</div>
							</div>
						</span>
						<span class="filter-toggle date">
							<span class="filter-text">
								<span class="pre-text"><span class="icon icon-time"></span>Time</span>
								<span class="text">
									<span class="text-inner">Today</span>
									<span class="icon icon-caret-down"></span>
								</span>
							</span>
							<div class="filter-dropdown">
								<div class="filter-inner">
									<div class="filter date">
										<div class="filters">
											<span class="any">any day</span><span class="today selected">today</span><span class="tomorrow">this week</span><span class="custom">custom</span>
										</div>
										<div>
											<div class="custom-select"><div class="any time-range"></div><div class="any time-display">any time</div></div>
											<div class="custom-select selected"><div class="today time-range"></div><div class="today time-display">any time</div></div>
											<div class="custom-select">
												<div class="day-of-week">
													<% dayOfWeek = Date.today() %>
													<% 7.times do %>
														<div day-of-week="<%= dayOfWeek.to_time.strftime("%w") %>"><div class="day"><%= dayOfWeek.to_time.strftime("%a") %></div><div class="date"><%= dayOfWeek.to_time.strftime("%b %-d") %></div></div>
														<% dayOfWeek = dayOfWeek + 1 %>
													<% end %>
												</div>
												<div class="tomorrow time-range"></div><div class="tomorrow time-display">any time</div>
											</div>
											<div class="custom-select">
												<span class="icon icon-calendar"></span><input type="text" class="custom-start"/> to <span class="icon icon-calendar"></span><input type="text" class="custom-end"/>
												<div class="custom time-range"></div><div class="custom time-display">any time</div>
												<!-- <div class="custom date-range"></div>
												<div class="custom date-display">today</div> -->
											</div>
										</div>
									</div>
								</div>
							</div>
						</span>
						<span class="filter-toggle price">
							<span class="filter-text">
								<span class="pre-text"><span class="icon icon-credit-card"></span>Cost</span> 
								<span class="text">
									<span class="text-inner">Any Price</span>
									<span class="icon icon-caret-down"></span>
								</span>
							</span>
							<div class="filter-dropdown">
								<div class="filter-inner">
									<div class="price-range"></div><div class="price-display">any price</div>
								</div>
							</div>
						</span>
						<span class="filter-toggle filter-action action-clear">
							<span class="filter-text">
								<span class="pre-text"><span class="icon icon-trash"></span>clear</span>
							</span>
						</span>
						<span class="filter-toggle filter-action action-save" <%= current_user ? "linkto='new-channel'" : "linkto='shunt'" %>>
							<span class="filter-text">
								<span class="pre-text"><span class="icon icon-save"></span>save</span>
							</span>
						</span>
					</div>
				</div>
			</div>
		</div>
	</div>
	<div class="expandobar">
		<div class="subbar">
			<div class="sort-by">Sorted by <span class="sort selected" sort-type="popularity">popularity</span> / <span class="sort" sort-type="date">date</span></div>
			<div class="num-occurrences">showing <span class="num-occurrences-count"><%= @allOccurrences.size %></span> events</div>
		</div>
		<div class="expandobar-inner">
			<span>&#9660;</span>show advanced options<span>&#9660;</span>
		</div>
	</div>
<% end %>

<% content_for :body do %>
	<div id="content">
		<div id="map-wrapper">
			<div id="map"></div>
		</div>
		<div class="main">
			<div class="inner">
				<div class="filter-summary">
					Showing <span class="num-events">27</span> <span class="price-filter">Free</span> <span class="tag-filter">Rock/Pop</span> events <span class="time-filter">Today</span>
				</div>
				<ul class="events">
					<%= render :partial => "event_list", :locals => { :occurrences => @occurrences, :offset => @offset } %>
				</ul>
			</div>
			<img id="loading" src="/assets/ajax-loader.gif" />
		</div>
		<%#= render :partial => "layouts/grid" %>
	</div>
<% end %>

<% content_for :overlay do %>
	<div class="mode">
		<div class="overlay">
			<div class="background">
			</div>			
			<div class="insert-point">
				<div class="window">
				</div>
			</div>
		</div>
	</div>
<% end %>
