<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/xhtml">
<head>
  <meta http-equiv="Content-Type" content="text/html; charset=utf-8"/>
  <title>Halfpastnow - Details</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <link href='http://fonts.googleapis.com/css?family=Roboto:400,100,300,900,700italic,900italic,700,500italic,500,400italic,300italic,100italic' rel='stylesheet' type='text/css'>
  <% content_for :meta do %>
    <meta property="og:type" content="halfpastnow:event"/>
    <meta property="og:url" content="http://www.halfpastnow.com/events/show/<%= @occurrence.id %>?fullmode=true"/>
    <meta property="og:site_name" content="halfpastnow"/>
    <meta property="og:image" content="<%= @event.cover_image_url %>"/>
    <meta property="og:title" content="<%= @event.title %> at <%= @event.venue.name %> on halfpastnow.com">
    <meta property="og:description" content="<%= strip_tags(@event.description) %>"/>
  <% end %>
</head>
<% content_for :head do %>
  <%= stylesheet_link_tag "elastislide", "details" %>
  <%= javascript_include_tag "jquery.elastislide" %>
  <script type="text/javascript">
    var id = "<%= @occurrence.id  %>";
    var type = "event";
    var root_url = "http://www.halfpastnow.com/";
    var link = root_url + "?" + type + "_id=" + id;
    var facebook_url = "http://www.halfpastnow.com/" + type + "s/show/" + id + "?fullmode=true";
    var app_id = "475386955806720";
    var redirect = "http://www.halfpastnow.com";
    var bookmark_id = "<%= @bookmarkId.to_s %>";
    var attending_id = "<%= @attendingId.to_s %>";
    var bookmarkList_id = "<%= @occurrence.id %>";
    var toggle = false;
    console.log(id + ' ' + bookmark_id)
    $(function () {


      window.fbAsyncInit = function () {
        console.log("Loaded FB 2");
        FB.init({
          appId: '475386955806720', // App ID
          status: true, // check login status
          cookie: true, // enable cookies to allow the server to access the session
          xfbml: true  // parse XFBML
        });
      };

      // Load the SDK Asynchronously
      (function (d) {
        var js, id = 'facebook-jssdk';
        if (d.getElementById(id)) {
          return;
        }
        js = d.createElement('script');
        js.id = id;
        js.async = true;
        js.src = "//connect.facebook.net/en_US/all.js";
        d.getElementsByTagName('head')[0].appendChild(js);
      }(document));// delete below

    });


    $(function () {
      console.log("Loaded share stuff");


      // The "bookmark" class won't be here if a user isn't logged in
      $('.bookmark-share .bookmark').click(function () {
        console.log("Fullmode bookmark");
        var that = $(this);
        if (that.hasClass('add')) {
          var bookmarked_type = "";
          // var lnk = 'http://www.halfpastnow.com/mobile/og/'+id;
          var lnk = 'http://www.halfpastnow.com/events/show/' + id + '?fullmode=true';
          console.log("Bookmarks: " + lnk);
          switch (type) {
            case "event":
              (bookmarked_type = "Occurrence") || (bookmarked_type = "Recurrence");
              FB.api(
                '/me/halfpastnow:bookmark',
                'post',
                { event: lnk },
                function (response) {
                  if (!response || response.error) {
                    // alert('Error occured'+response);
                  } else {
                    // alert('Post event was successful! Action ID: ' + response.id);
                  }
                });
              break;
            case "venue":
              bookmarked_type = "Venue";
              break;
            case "act":
              bookmarked_type = "Act";
              break;
          }
          ;
          $.getJSON('/bookmarks/custom_create', { bookmark: { "type": bookmarked_type, "id": id } }, function (data) {
            console.log("new bookmark full mode");
            console.log(data);
            that.removeClass('add').addClass('remove');
            that.html("<img src='/assets/images/icon-bookmark-large.png'/>");
            bookmark_id = data;
          });
        }
        else if (that.hasClass('remove')) {
          // $.getJSON('/bookmarks/destroy/', { id: bookmark_id }, function(data) {
          // 	that.addClass('add').removeClass('remove');
          // });
          $.getJSON('/bookmarks/destroy/' + bookmark_id, function (data) {
            that.addClass('add').removeClass('remove');
            that.html("<img src='/assets/images/icon-bookmark-large.png'/>");
          });
        }
      });

      // This "attending" class won't be here if the user isn't logged in
      $('.attending').click(function (e) {
        console.log("checking....")
        var that = $(this);
        if (that.hasClass('add')) {
          var bookmarked_type = "Occurrence";
          var lnk = 'http://www.halfpastnow.com/events/show/' + id + '?fullmode=true';
          console.log("Attend: " + lnk);
          FB.api(
            '/me/halfpastnow:attend',
            'post',
            { event: lnk },
            function (response) {
              // if (!response || response.error) {
              //    alert('Error occured'+response);
              // } else {
              //    alert('Post event was successful! Action ID: ' + response.id);
              // }
            });

          $.getJSON('/bookmarks/attending_create', { bookmark: { "type": bookmarked_type, "id": id } }, function (data) {
            console.log("new attending bookmark");
            that.removeClass('add').addClass('remove');
            that.text("Planning on Attending");
            $(".re-rsvp").text("Visit RSVP Site Again");
            attending_id = data;
          });
        }
        else if (that.hasClass('remove')) {
          e.preventDefault();
          $.getJSON('/bookmarks/destroy/' + attending_id, function (data) {
            that.addClass('add').removeClass('remove');
            that.text("No longer attending (click again to attend!)");
            $(".re-rsvp").text("");
          });
        }
      });

      $('.bookmark-share').click(function () {
        console.log("Anything?????");
      });

      $('.bookmark-share .email').click(function () {
        var url = 'mailto:?body=' + link;
        window.open(url, '_blank');
        window.focus();
      });

      $('.bookmark-share .facebook').click(function () {

        var url = "http://www.facebook.com/sharer.php?u=" + facebook_url;
        window.open(url, '_blank');
        window.focus();
      });

      $('.bookmark-share .twitter').click(function () {
        // var url = 'https://twitter.com/intent/tweet?text=' + link;
        var title = "<%= @event.title  %>";

        var url = 'http://twitter.com/intent/tweet?text=' + title.replace(/(<([^>]+|)>)/ig, "").replace("&amp;", "and").substring(0, 50) + ' ' + link + ' @halfpastnow %23discoveraustin';

        window.open(url, '_blank');
        window.focus();
      });

      $('.bookmark-share .comment-tp .add-tp').click(function () {
        var that = $('.add-tp');
        if (toggle) {
          $('.popup-box').hide();
          $('.popup-box-1').hide();
        }
        else {
          if (that.hasClass('add')) {
            submit_comment();
            $('.popup-box').show();
          }
          else {
            $('.popup-box-1').show();
          }

        }
        toggle = !toggle;
      });
    });
    function submit_comment() {
      var text = $('.comment-text').val();
      $('.popup-box').hide();
      that = $('.add-tp');
      toggle = !toggle;
      that.removeClass('add').addClass('remove');
      $.getJSON('/bookmarks/add_to_featuredlist', { bookmark: { "type": "Occurrence", "id": <%= @occurrence.id  %>, "comment": text } }, function (data) {
        bookmark_id = data;
      });

      $(".comment-text-1").val(text);
    }
    function deleteTP() {

      $('.popup-box-1').hide();
      toggle = !toggle;
      that = $('.add-tp');
      $.getJSON('/bookmarks/destroyBookmarkedList/' + bookmarkList_id, function (data) {
        that.removeClass('remove').addClass('add');
      });
    }
    function edit_comment() {
      $('.popup-box-1').hide();
      toggle = !toggle;
      var text = $('.comment-text-1').val();
      console.log("Edit comment" + text);
      $.getJSON('/bookmarks/update_comment', { bookmark: { "type": "Occurrence", "id": bookmarkList_id, "comment": text } }, function (data) {
        bookmark_id = data;

      });
    }
  </script>

  <script>
    function postList() {
      FB.api(
        '/me/halfpastnow:subscribe',
        'post',
        { toppick: "<%= @url %>" },
        function (response) {
          if (!response || response.error) {
            // alert('Error occured'+response);
          } else {
            // alert('Post list was successful! Action ID: ' + response.id);
          }
        });
    }


    function likeit() {
      console.log("<%= @url1 %>")
      FB.api(
        '/me/og.likes',
        'post',
        { object: "<%= @url1 %>" },
        function (response) {
          if (!response || response.error) {
            // alert('Error occured'+response);
          } else {
            // alert('Successfully post on your timeline');
          }
        });
      window.open(url, '_blank');
      window.focus();
    }
  </script>
<% end %>

<% content_for :body do %>

  <section class="details">
  <section class="recommend-events">
    <div class="container">
      <a class="link" href="#"><i class="icon-left-arrow"></i> back to search results</a>
      <a class="link" href="#" data-target="recommend-events-wrapper"><i class="icon-bottom-arrow"></i> recommended
        events</a>
    </div>
  </section>
  <div class="container">
  <div class="event-main">
    <h2><%= @event.title %></h2>

    <div class="row">
      <div class="price left">
        <% if @event.price %>
          <%= @event.price != 0 ? "$" + number_with_precision(@event.price, :precision => 2) : "FREE" %>
        <% end %>
      </div>
      <div class="right">
        <div class="share bookmark-share">
          <a href="#">
               <span class="nice-button bookmark-button <%= current_user ? "bookmark" : "" %> <%= @bookmarkId.nil? ? "add" : "remove" %>"  <%= current_user ? "" : "linkto='shunt'" %>>
                 <%= @bookmarkId.nil? ? image_tag("images/icon-bookmark-large.png") : image_tag("images/icon-bookmark-large.png") %>
	            </span>
          </a>
          <a href="#">
            <img src="/assets/images/icon-calendar.png" alt=""/>
          </a>
          <a href="#" class="twitter"><img src="/assets/images/icon-twitter.png" alt=""/></a>
          <a href="#" class="facebook"><img src="/assets/images/icon-facebook.png" alt=""/></a>
        </div>
      </div>
    </div>
    <div class="clearfix">
      <div class="left">
        <address>
          <h4>South Congress</h4>
          Holy Mountain<br/>
          617 East 7th Street<br/>
          Austin, TX 78701
        </address>
        <h4>Dates &amp; Times</h4>
        <ul>
          <li>Everyday, 7:00pm to 11:00pm</li>
          <li>Tuesday, 6:00pm</li>
          <li>Friday, Sept. 20, 2013</li>
        </ul>
      </div>
      <div class="right">

        <!--<a href="#" class="btn btn-large btn-danger">I'm Going</a>-->

        <input type="hidden" id="event" value="<%= @event %>"/>
        <input type="hidden" id="id" value="<%= @occurrence.id %>"/>
        <% if !@event.ticket_url.blank? %>
          <a href="<%= @event.ticket_url %>" target="_blank" class="btn btn-large btn-danger <%= current_user ? "attending" : "" %> <%= @attendingId.nil? ? "add" : "remove" %>"  <%= current_user ? "" : "linkto='shunt'" %>>
            <%= @attendingId.nil? ? "Tickets" : "Already Going" %>
          </a>

          <div class="rsvp-center" style="text-align:center; vertical-align:text-top;">
            <a href='<%= @event.ticket_url %>' target='_blank' class='re-rsvp' style="font-size:16px;"><%= @attendingId.nil? ? "" : "Visit Ticketing Site Again" %></a>
          </div>
        <% else %>
		<span class="btn btn-large btn-danger <%= current_user ? "attending" : "" %> <%= @attendingId.nil? ? "add" : "remove" %>"  <%= current_user ? "" : "linkto='shunt'" %>>
			<%= @attendingId.nil? ? "I'm Going!" : "Planning on Attending" %>
		</span>

        <% end %>
        <a href="#" class="btn btn-large btn-danger">Get Tickets</a>
      </div>
    </div>
    <div class="accordion" id="details-container">
      <div class="accordion-heading">
        <a class="accordion-toggle" data-toggle="collapse" data-parent="#details-container" href="#details">Details
          <i class="caret pull-right"></i></a>
      </div>
      <div id="details" class="accordion-body collapse in">
        <div class="accordion-inner">
          <%= raw(@event.description) %>
        </div>
      </div>
    </div>
    <div class="accordion" id="tag-container">
      <div class="accordion-heading">
        <a class="accordion-toggle" data-toggle="collapse" data-parent="#tag-container" href="#tags">Tags
          <i class="caret pull-right"></i></a>
      </div>
      <div id="tags" class="accordion-body collapse in">
        <div class="accordion-inner">
          <p>
            <% unless @event.tags.length == 0 %>
              <%= @event.tags.collect { |tag| tag.name } * "," %></li>
            <% end %>
          </p>
        </div>
      </div>
    </div>
    <div class="accordion" id="who-container">
      <div class="accordion-heading">
        <a class="accordion-toggle" data-toggle="collapse" data-parent="#who-container" href="#who">Who's Going
          <i class="caret pull-right"></i></a>
      </div>
      <div id="who" class="accordion-body collapse in">
        <div class="accordion-inner">
          <a href="#" class="user"><img src="/assets/images/user-thumb01.png" alt=""/></a>
          <a href="#" class="user"><img src="/assets/images/user-thumb02.png" alt=""/></a>
          <a href="#" class="user"><img src="/assets/images/user-thumb01.png" alt=""/></a>
          <a href="#" class="user"><img src="/assets/images/user-thumb02.png" alt=""/></a>
          <a href="#" class="user"><img src="/assets/images/user-thumb01.png" alt=""/></a>
          <a href="#" class="user"><img src="/assets/images/user-thumb02.png" alt=""/></a>
          <a href="#" class="user"><img src="/assets/images/user-thumb01.png" alt=""/></a>
          <a href="#" class="user"><img src="/assets/images/user-thumb02.png" alt=""/></a>
        </div>
      </div>
    </div>
  </div>
  <div class="event-other-details">
    <ul class="nav nav-tabs">
      <li class="active"><a data-toggle="tab" href="#photos">Photos</a></li>
      <li class=""><a data-toggle="tab" href="#videos">Videos</a></li>
      <li class=""><a data-toggle="tab" href="#music">Music</a></li>
    </ul>
    <div class="tab-content">
      <div id="photos" class="tab-pane fade in active">
        <div class="gallery">
          <!-- Elastislide Carousel -->
          <ul id="carousel" class="elastislide-list">
            <li data-preview="/assets/images/large/4.jpg">
              <a href="#"><img src="/assets/images/small/4.jpg" alt="image04"/></a></li>
            <li data-preview="/assets/images/large/5.jpg">
              <a href="#"><img src="/assets/images/small/5.jpg" alt="image05"/></a></li>
            <li data-preview="/assets/images/large/6.jpg">
              <a href="#"><img src="/assets/images/small/6.jpg" alt="image06"/></a></li>
            <li data-preview="/assets/images/large/7.jpg">
              <a href="#"><img src="/assets/images/small/7.jpg" alt="image07"/></a></li>
            <li data-preview="/assets/images/large/11.jpg">
              <a href="#"><img src="/assets/images/small/11.jpg" alt="image11"/></a></li>
            <li data-preview="/assets/images/large/1.jpg">
              <a href="#"><img src="/assets/images/small/1.jpg" alt="image01"/></a></li>
            <li data-preview="/assets/images/large/2.jpg">
              <a href="#"><img src="/assets/images/small/2.jpg" alt="image02"/></a></li>
            <li data-preview="/assets/images/large/3.jpg">
              <a href="#"><img src="/assets/images/small/3.jpg" alt="image03"/></a></li>
            <li data-preview="/assets/images/large/8.jpg">
              <a href="#"><img src="/assets/images/small/8.jpg" alt="image08"/></a></li>
            <li data-preview="/assets/images/large/9.jpg">
              <a href="#"><img src="/assets/images/small/9.jpg" alt="image09"/></a></li>
            <li data-preview="/assets/images/large/10.jpg">
              <a href="#"><img src="/assets/images/small/10.jpg" alt="image10"/></a></li>
          </ul>
          <!-- End Elastislide Carousel -->

          <div class="image-preview">
            <% unless (@event.venue.fb_picture.blank? && @event.fb_picture.blank? && @event.pictures.nil? && @event.acts.nil?) %>
              <div id="galleria" style="height:367px;width:550px;">
                <% unless @event.venue.fb_picture.blank? %>
                  <img src="<%= @event.venue.fb_picture %>" data-title="<%= @event.venue.name %>">
                <% end %>
                <% @event.venue.pictures.each do |pic| %>
                  <a href="<%= pic.image_url(:large).to_s %>"><img src="<%= pic.image_url(:tiny).to_s %>" data-title="<%= @event.venue.name %>" data-big="<%= pic.image_url(:full).to_s %>"></a>
                <% end %>

                <% unless @event.fb_picture.blank? %>
                  <img src="<%= @event.fb_picture %>" data-title="<%= @event.title %>">
                <% end %>
                <% @event.pictures.each do |pic| %>
                  <a href="<%= pic.image_url(:large).to_s %>"><img src="<%= pic.image_url(:tiny).to_s %>" data-title="<%= @event.title.first(25) %>" data-big="<%= pic.image_url(:full).to_s %>"></a>
                <% end %>

                <% @event.acts.each do |artists| %>
                  <% unless artists.fb_picture.blank? %>
                    <img src="<%= artists.fb_picture %>" data-title="<%= artists.name %>">
                  <% end %>
                  <% artists.pictures.each do |pic| %>
                    <a href="<%= pic.image_url(:large).to_s %>"><img src="<%= pic.image_url(:tiny).to_s %>" data-title="<%= artists.name %>" data-big="<%= pic.image_url(:full).to_s %>"></a>
                  <% end %>
                  <br>
                <% end %>
              </div>
            <% end %>
            <script type="text/javascript">
              Galleria.loadTheme('/assets/galleria.classic.min.js');
              Galleria.run('#galleria');
            </script>
          </div>
        </div>
      </div>
      <div id="videos" class="tab-pane fade in">
        <%#= raise @event.acts.inspect %>
        <% unless @event.acts.length == 0 %>
          <div class="featuring block">
            <h2>Featuring</h2>

            <div class="block-inner">
              <% @event.acts.each_with_index do |act, index| %>
                <% if @fullmode %>
                  <a href="/acts/show/<%= act.id %>?fullmode=true" class="act-name"><%= act.name %></a><%= (index != @event.acts.length - 1) ? ", " : "" %>
                <% else %>
                  <span link-id="<%= act.id %>" linkto="act" class="act-name"><%= act.name %></span><%= (index != @event.acts.length - 1) ? ", " : "" %>
                <% end %>
              <% end %>
              <div class="embeds">

                <% @event.acts.each do |act| %>
                  <% act.embeds.select { |e| e.primary }.each do |embed| %>
                    <div class="embed-act-name"><%= act.name %></div>
                    <%= raw(embed.source) %>
                  <% end %>
                <% end %>
                <script>
                  $('.embeds').ready(function(){

                    var element = $('.widget_iframe').detach();
                    $('#music').append(element);
                  })
                </script>
              </div>
            </div>
          </div>
        <% end %>
      </div>
      <div id="music" class="tab-pane fade in">
        Music
      </div>
    </div>
    <div class="accordion" id="map-container">
      <div class="accordion-heading">
        <a class="accordion-toggle" data-toggle="collapse" data-parent="#map-container" href="#map">617 East 7th Street
          <i class="caret pull-right"></i></a>
      </div>
      <div id="map" class="accordion-body collapse in">
        <div class="accordion-inner">
          <a class="map-link" href="http://maps.google.com/maps?q=<%= @event.venue.latitude %>,<%= @event.venue.longitude %>" style="float: left;" target="_blank"><img class="map" src="http://maps.googleapis.com/maps/api/staticmap?size=550x300&zoom=15&maptype=roadmap&markers=color:gray%7C<%= @event.venue.latitude %>,<%= @event.venue.longitude %>&sensor=false"/></a>
        </div>
      </div>
    </div>
    <div class="accordion" id="neighbourhood-container">
      <div class="accordion-heading">
        <a class="accordion-toggle" data-toggle="collapse" data-parent="#neighbourhood-container" href="#neighbourhood">In
          the Neighbourhood <i class="caret pull-right"></i></a>
      </div>
      <div id="neighbourhood" class="accordion-body collapse in">
        <div class="accordion-inner product-list clearfix">
          <% @near_by_events.each do |event| %>
          <article class="product-item">
            <figure><a href="#">
              <% if event.pictures.first %>
                <img src="<%= event.pictures.first.image_url(:full) %>" alt="Event picture"/>
              <% elsif event.acts.length != 0 && event.acts.first.pictures.first %>
                <img src="<%= event.acts.first.pictures.first.image_url(:full) %>" alt="occurrence pic"/>
              <% elsif event.venue.pictures.first %>
                <img src="<%= event.venue.pictures.first.image_url(:full) %>" alt="venue pic"/>
              <% else %>
                <img src="<%= event.cover_image_url ? event.cover_image_url : "/assets/placeholder.png" %>" alt="cover pic"/>
              <% end %>


            </a>

            </figure>
            <div class="name"><a href="#"><%= event.title %></a>
            </div>
          </article>
         <% end %>
        </div>
      </div>
    </div>
    <div class="ad-contaniner">
      <img src="/assets/images/ad02.gif" alt=""/>
      <span class="muted">Advertisement</span>
    </div>
  </div>
  </div>
  </section>
  <section class="recommend-events">
    <div id="recommend-events-wrapper">
      <div class="content slider">
        <div id="recommended-list">
          <% @occurrences.empty? ? occurrences=@all_occurrences : occurrences=@occurrence %>
          <% occurrences.each do |occurrence| %>
            <article class="slide-item">
              <figure><a href="#">
                <% if occurrence.event.pictures.first %>
                  <img src="<%= occurrence.event.pictures.first.image_url(:full) %>" alt="Event picture"/>
                <% elsif occurrence.event.acts.length != 0 && occurrence.event.acts.first.pictures.first %>
                  <img src="<%= occurrence.event.acts.first.pictures.first.image_url(:full) %>" alt="occurrence pic"/>
                <% elsif occurrence.event.venue.pictures.first %>
                  <img src="<%= occurrence.event.venue.pictures.first.image_url(:full) %>" alt="venue pic"/>
                <% else %>
                  <img src="<%= occurrence.event.cover_image_url ? occurrence.event.cover_image_url : "/assets/placeholder.png" %>" alt="cover pic"/>
                <% end %>
              </a></figure>
              <div class="name"><a href="#"><%= occurrence.event.title %></a>
              </div>
            </article>
          <% end %>
        </div>
        <a class="prev" id="recommended-list_prev" href="#"><span>prev</span></a>
        <a class="next" id="recommended-list_next" href="#"><span>next</span></a>
      </div>
    </div>
  </section>
<% end %>

<script type="text/javascript">

  // example how to integrate with a previewer

  var current = 0,
    $preview = $('#preview'),
    $carouselEl = $('#carousel'),
    $carouselItems = $carouselEl.children(),
    carousel = $carouselEl.elastislide({
      current: current,
      minItems: 3,
      onClick: function (el, pos, evt) {

        changeImage(el, pos);
        evt.preventDefault();

      },
      onReady: function () {

        changeImage($carouselItems.eq(current), current);

      }
    });

  function changeImage(el, pos) {
    $preview.attr('src', el.data('preview'));
    $carouselItems.removeClass('current-img');
    el.addClass('current-img');
    carousel.setCurrent(pos);
  }

</script>

</body>
</html>
